<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Naijaland - Affordable Land for Sale in Nigeria</title>
    <meta name="description"
        content="Buy verified and affordable land in Nigeria. Explore listings by location, size, and price. Secure your property today with Naijaland.">
    <meta name="keywords"
        content="land for sale in Nigeria, Naijaland, buy land Nigeria, affordable land Nigeria, property listing Nigeria">
    <meta name="author" content="Naijaland">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.naijaland.site" />

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.naijaland.site/">
    <meta property="og:title" content="Naijaland - Affordable Land for Sale in Nigeria">
    <meta property="og:description"
        content="Buy verified and affordable land in Nigeria. Explore listings by location, size, and price.">
    <meta property="og:image" content="https://www.naijaland.site/images/naijaland-social-share.jpg">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.naijaland.site/">
    <meta property="twitter:title" content="Naijaland - Affordable Land for Sale in Nigeria">
    <meta property="twitter:description"
        content="Buy verified and affordable land in Nigeria. Explore listings by location, size, and price.">
    <meta property="twitter:image" content="https://www.naijaland.site/images/naijaland-social-share.jpg">

    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/icons/favicon-32x32.png">
    <meta name="theme-color" content="#10b981">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="NaijaLand">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/android-chrome-192x192.png">
    <link rel="apple-touch-startup-image" href="/icons/splash-640x1136.png"
        media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-750x1334.png"
        media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1242x2208.png"
        media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1125x2436.png"
        media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1536x2048.png"
        media="(min-device-width: 768px) and (max-device-width: 1024px) and (-webkit-min-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1668x2224.png"
        media="(min-device-width: 834px) and (max-device-width: 834px) and (-webkit-min-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/icons/splash-2048x2732.png"
        media="(min-device-width: 1024px) and (max-device-width: 1024px) and (-webkit-min-device-pixel-ratio: 2) and (orientation: portrait)">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="NaijaLand">
    <meta name="msapplication-TileColor" content="#10b981">
    <meta name="msapplication-TileImage" content="/icons/mstile-144x144.png">
    <meta name="msapplication-config" content="/browserconfig.xml">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <style>
        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .auth-form {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .owned-property {
            border-left: 4px solid #10b981;
        }

        .lazy-image {
            background-color: #f3f4f6;
            background-image: linear-gradient(to right, #f3f4f6 0%, #e5e7eb 20%, #f3f4f6 40%, #f3f4f6 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDiaGKYPC9aGX7f6mbFgcce1KlWzF-popo",
            authDomain: "naijaland-ff376.firebaseapp.com",
            projectId: "naijaland-ff376",
            storageBucket: "naijaland-ff376.appspot.com",
            messagingSenderId: "836804901521",
            appId: "1:836804901521:web:bd8cc146b3896a6217dd30"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <div id="app" class="min-h-screen flex flex-col">
        <nav class="bg-green-700 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-home text-2xl"></i>
                    <span class="text-xl font-bold">NaijaLand</span>
                </div>
                <div id="nav-links">
                    <button id="login-btn"
                        class="bg-white text-green-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition">Login/Register</button>
                </div>
            </div>
        </nav>

        <main class="flex-grow container mx-auto px-4 py-8">
            <div id="public-view">
                <section class="mb-12">
                    <h1 class="text-4xl font-bold text-green-800 mb-4">Find Your Perfect Land</h1>
                    <p class="text-lg text-gray-700 mb-6">
                        Welcome to NaijaLand, your trusted partner in land acquisition. We offer land properties
                        in good locations at competitive prices. Whether you're looking to build your dream home or
                        make a strategic investment, we have options to suit every need.
                    </p>
                    <p class="text-lg text-gray-700 mb-8">
                        Register today to access detailed property information, make secure payments, book an
                        inspection, and
                        get expert advice from our team.
                    </p>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-green-800 mb-6">Available Properties</h2>

                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">Location</label>
                                <select id="filter-location" class="w-full p-2 border rounded">
                                    <option value="">All Locations</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Price Range (₦)</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="min-price" placeholder="Min"
                                        class="w-full p-2 border rounded">
                                    <span>to</span>
                                    <input type="number" id="max-price" placeholder="Max"
                                        class="w-full p-2 border rounded">
                                </div>
                            </div>
                        </div>
                        <button id="apply-filters"
                            class="mt-4 bg-green-700 text-white px-6 py-2 rounded hover:bg-green-800 transition w-full">
                            Apply Filters
                        </button>
                    </div>

                    <div id="property-loading" class="text-center py-12">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-lg text-gray-600">Loading Properties...</p>
                    </div>

                    <div id="property-reload" class="hidden text-center py-12">
                        <p class="text-lg text-red-600 mb-4">Failed to load properties. Please check your connection and
                            try again.</p>
                        <button id="reload-properties-btn"
                            class="bg-green-700 text-white px-6 py-3 rounded-lg hover:bg-green-800 transition">
                            <i class="fas fa-sync-alt mr-2"></i>Reload Properties
                        </button>
                    </div>

                    <div id="property-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>

                    <div id="pagination" class="flex justify-center mt-8 hidden">
                        <button id="prev-page" class="px-4 py-2 bg-gray-200 rounded-l-md mr-1 disabled:opacity-50"
                            disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <div id="page-numbers" class="flex">
                        </div>
                        <button id="next-page" class="px-4 py-2 bg-gray-200 rounded-r-md ml-1 disabled:opacity-50">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </section>
            </div>
            <div id="private-dashboard" class="hidden">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="md:w-2/3">
                        <h1 class="text-3xl font-bold text-green-800 mb-6">Welcome, <span id="user-name"></span></h1>

                        <section class="mb-8 bg-white p-6 rounded-lg shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-green-800">My Land Investments</h2>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i> Updates may take up to 24 hours after
                                    payment
                                </div>
                            </div>

                            <div id="my-investments-list" class="space-y-4">
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-folder-open text-4xl mb-2"></i>
                                    <p>You don't have any land investments yet</p>
                                </div>
                            </div>
                        </section>

                        <section class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-green-800">Available Properties</h2>
                                <div class="relative">
                                    <input type="text" id="search-properties" placeholder="Search properties..."
                                        class="pl-10 pr-4 py-2 border rounded-lg w-full md:w-64">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                            </div>

                            <div id="dashboard-property-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            </div>

                            <div id="dashboard-pagination" class="flex justify-center mt-8 hidden">
                                <button id="dashboard-prev-page"
                                    class="px-4 py-2 bg-gray-200 rounded-l-md mr-1 disabled:opacity-50" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <div id="dashboard-page-numbers" class="flex">
                                </div>
                                <button id="dashboard-next-page"
                                    class="px-4 py-2 bg-gray-200 rounded-r-md ml-1 disabled:opacity-50">
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </section>

                        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h2 class="text-2xl font-bold text-green-800 mb-4">Land Calculator</h2>
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label class="block text-gray-700 mb-2">Select Property</label>
                                    <select id="calculator-property" class="w-full p-3 border rounded-lg mb-4">
                                        <option value="">-- Select Property --</option>
                                    </select>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 mb-2">Price per Plot (₦)</label>
                                            <input type="number" id="price-per-plot"
                                                class="w-full p-3 border rounded-lg" placeholder="Auto-filled" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2">Number of Plots</label>
                                            <input type="number" id="number-of-plots"
                                                class="w-full p-3 border rounded-lg" placeholder="Enter number of plots"
                                                min="1">
                                        </div>
                                    </div>

                                    <button id="calculate-price"
                                        class="mt-4 bg-green-700 text-white px-6 py-3 rounded-lg hover:bg-green-800 transition w-full">
                                        Calculate Total Price
                                    </button>
                                </div>
                            </div>
                            <div id="calculator-result" class="mt-6 p-4 bg-green-100 rounded-lg hidden">
                                <h3 class="font-bold text-green-800">Result:</h3>
                                <p id="result-text" class="text-lg"></p>
                                <button id="proceed-to-payment"
                                    class="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                                    Proceed to Payment
                                </button>
                            </div>
                        </section>
                    </div>

                    <div class="md:w-1/3">
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h2 class="text-xl font-bold text-green-800 mb-4">Account Information</h2>
                            <div class="space-y-3">
                                <p><span class="font-semibold">Name:</span> <span id="account-name"></span></p>
                                <p><span class="font-semibold">Email:</span> <span id="account-email"></span></p>
                                <p><span class="font-semibold">Phone:</span> <span id="account-phone"></span></p>
                                <p><span class="font-semibold">Location:</span> <span id="account-location"></span></p>
                            </div>
                            <button id="edit-profile" class="mt-4 text-green-700 hover:text-green-900 transition">
                                <i class="fas fa-edit mr-2"></i>Edit Profile
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h2 class="text-xl font-bold text-green-800 mb-4">Payment Information</h2>
                            <div class="mb-4">
                                <h3 class="font-semibold mb-2">Bank Transfer</h3>
                                <p class="text-sm mb-1">Bank Name: <span class="font-medium">United Bank Of
                                        Africa</span></p>
                                <p class="text-sm mb-1">Account Name: <span class="font-medium">Prince Kaka Global
                                        Resources</span></p>
                                <p class="text-sm mb-1">Account Number: <span class="font-medium">1028081103</span></p>
                            </div>
                            <button id="paystack-button"
                                class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                                <i class="fab fa-cc-stripe mr-2"></i> Pay with Paystack
                            </button>
                            <button id="upload-receipt"
                                class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center mt-4">
                                <i class="fas fa-upload mr-2"></i> Upload Payment Receipt
                            </button>
                        </div>

                        <div id="admin-controls" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                            <h2 class="text-xl font-bold text-green-800 mb-4">Admin Controls</h2>
                            <button id="update-investments"
                                class="w-full bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 transition mb-3">
                                <i class="fas fa-sync-alt mr-2"></i> Update All Investments
                            </button>
                            <button id="add-property"
                                class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition">
                                <i class="fas fa-plus mr-2"></i> Add New Property
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold text-green-800 mb-4">Need Help?</h2>
                            <p class="mb-4">Contact our support team for assistance with your purchase.</p>
                            <a href="https://wa.me/2348160952082" target="_blank"
                                class="block w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition text-center">
                                <i class="fab fa-whatsapp mr-2"></i> Chat on WhatsApp
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white py-8">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">NaijaLand</h3>
                        <p>Your trusted real estate consultant, we help you build wealth through real estate.</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                        <ul class="space-y-2">
                            <li><a href="https://www.naijaland.site/faq/"
                                    class="hover:text-green-400 transition">FAQ</a></li>
                            <li><a href="https://www.naijaland.site"
                                    class="hover:text-green-400 transition">Properties</a></li>
                            <li><a href="https://www.naijaland.site/about/"
                                    class="hover:text-green-400 transition">About Us</a>
                            </li>
                            <li>
                                <a href="https://wa.me/2348160952082" target="_blank"
                                    class="hover:text-green-400 transition">
                                    Message Us on WhatsApp
                                </a>
                            </li>
                            <li>
                                <a href="mailto:support@naijaland.site" class="hover:text-green-400 transition">
                                    Email Us
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Legal</h3>
                        <ul class="space-y-2">
                            <li><a href="https://www.naijaland.site/conditions/"
                                    class="hover:text-green-400 transition">Terms &
                                    Conditions</a></li>
                            <li><a href="https://www.naijaland.site/conditions/"
                                    class="hover:text-green-400 transition">Privacy
                                    Policy</a></li>
                        </ul>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-6 text-center">
                    <p>&copy; 2025 Prince Kaka Global Resources. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md auth-form">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="auth-modal-title" class="text-2xl font-bold text-green-800">Login</h2>
                    <button id="close-auth-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="login-form">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full p-3 border rounded-lg"
                            placeholder="Your email">
                    </div>
                    <div class="mb-6 relative">
                        <label class="block text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="login-password" class="w-full p-3 border rounded-lg pr-10"
                                placeholder="Your password">
                            <button type="button"
                                class="absolute right-3 top-3 text-gray-500 hover:text-gray-700 focus:outline-none password-toggle"
                                data-target="login-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button id="login-submit"
                        class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition mb-4">
                        Login
                    </button>
                    <div class="text-center">
                        <button id="show-forgot-password" class="text-green-700 hover:text-green-900 text-sm">
                            Forgot password?
                        </button>
                        <p class="mt-4 text-gray-600">Don't have an account? <button id="show-register"
                                class="text-green-700 hover:text-green-900">Register</button></p>
                    </div>
                </div>

                <div id="register-form" class="hidden">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="register-name" class="w-full p-3 border rounded-lg"
                            placeholder="Your full name">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Email</label>
                        <input type="email" id="register-email" class="w-full p-3 border rounded-lg"
                            placeholder="Your email" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="register-phone" class="w-full p-3 border rounded-lg"
                            placeholder="Your phone number" pattern="[0-9]{11}" title="Please enter 11 digits">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Location</label>
                        <input type="text" id="register-location" class="w-full p-3 border rounded-lg"
                            placeholder="Your location">
                    </div>
                    <div class="mb-4 relative">
                        <label class="block text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="register-password" class="w-full p-3 border rounded-lg pr-10"
                                placeholder="Create password" minlength="6" required>
                            <button type="button"
                                class="absolute right-3 top-3 text-gray-500 hover:text-gray-700 focus:outline-none password-toggle"
                                data-target="register-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-6 relative">
                        <label class="block text-gray-700 mb-2">Confirm Password</label>
                        <div class="relative">
                            <input type="password" id="register-confirm-password"
                                class="w-full p-3 border rounded-lg pr-10" placeholder="Confirm password" required>
                            <button type="button"
                                class="absolute right-3 top-3 text-gray-500 hover:text-gray-700 focus:outline-none password-toggle"
                                data-target="register-confirm-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-6 flex items-start">
                        <div class="flex items-center h-5">
                            <input id="accept-terms-checkbox" type="checkbox"
                                class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-green-300">
                        </div>
                        <label for="accept-terms-checkbox" class="ml-2 text-sm text-gray-700">
                            I agree to the <button type="button" id="view-terms"
                                class="text-green-600 hover:text-green-800">Terms & Conditions</button>
                        </label>
                    </div>

                    <button id="register-submit"
                        class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition mb-4">
                        Register
                    </button>
                    <div class="text-center">
                        <p class="text-gray-600">Already have an account? <button id="show-login"
                                class="text-green-700 hover:text-green-900">Login</button></p>
                    </div>
                </div>

                <div id="forgot-password-form" class="hidden">
                    <div class="mb-6">
                        <p class="text-gray-700 mb-4">Enter your email address and we'll send you a link to reset your
                            password.</p>
                        <label class="block text-gray-700 mb-2">Email</label>
                        <input type="email" id="forgot-email" class="w-full p-3 border rounded-lg"
                            placeholder="Your email">
                    </div>
                    <button id="forgot-submit"
                        class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition mb-4">
                        Send Reset Link
                    </button>
                    <div class="text-center">
                        <button id="show-login-from-forgot" class="text-green-700 hover:text-green-900">Back to
                            Login</button>
                    </div>
                </div>

                <div id="auth-loading" class="hidden text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p id="auth-loading-text">Processing...</p>
                </div>

                <div id="auth-message" class="hidden mt-4 p-3 rounded-lg text-center"></div>
            </div>
        </div>
    </div>

    <div id="edit-profile-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md auth-form">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-green-800">Edit Profile</h2>
                    <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="edit-name" class="w-full p-3 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="edit-phone" class="w-full p-3 border rounded-lg">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Location</label>
                    <input type="text" id="edit-location" class="w-full p-3 border rounded-lg">
                </div>

                <button id="save-profile"
                    class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition">
                    Save Changes
                </button>

                <div id="edit-message" class="hidden mt-4 p-3 rounded-lg text-center"></div>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md auth-form">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-green-800">Make Payment</h2>
                    <button id="close-payment-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Select Property</label>
                    <select id="payment-property" class="w-full p-3 border rounded-lg">
                        <option value="">-- Select Property --</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Price per Plot (₦)</label>
                        <input type="number" id="payment-price-per-plot" class="w-full p-3 border rounded-lg" readonly>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Number of Plots</label>
                        <input type="number" id="payment-plots" class="w-full p-3 border rounded-lg"
                            placeholder="Enter plots" min="1">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Amount (₦)</label>
                    <input type="number" id="payment-amount" class="w-full p-3 border rounded-lg"
                        placeholder="Auto-calculated" readonly>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Email for Payment Receipt</label>
                    <input type="email" id="payment-email" class="w-full p-3 border rounded-lg"
                        placeholder="Your email">
                </div>

                <button id="initiate-payment"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                    <i class="fab fa-cc-stripe mr-2"></i> Proceed to Payment
                </button>

                <div id="payment-message" class="hidden mt-4 p-3 rounded-lg text-center"></div>
            </div>
        </div>
    </div>

    <div id="sell-property-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md auth-form">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-green-800">Sell Your Property</h2>
                    <button id="close-sell-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Select Property to Sell</label>
                    <select id="sell-property-select" class="w-full p-3 border rounded-lg">
                        <option value="">-- Select Property --</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Selling Price (₦)</label>
                    <input type="number" id="sell-price" class="w-full p-3 border rounded-lg"
                        placeholder="Enter selling price">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Your Bank Account Details</label>
                    <input type="text" id="bank-name" class="w-full p-3 border rounded-lg mb-2" placeholder="Bank Name">
                    <input type="text" id="account-name-input" class="w-full p-3 border rounded-lg mb-2"
                        placeholder="Account Name">
                    <input type="text" id="account-number" class="w-full p-3 border rounded-lg"
                        placeholder="Account Number">
                </div>

                <button id="submit-sale"
                    class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition flex items-center justify-center">
                    <i class="fas fa-hand-holding-usd mr-2"></i> List Property for Sale
                </button>

                <div id="sell-message" class="hidden mt-4 p-3 rounded-lg text-center"></div>
            </div>
        </div>
    </div>

    <div id="add-property-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md auth-form">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-green-800">Add New Property</h2>
                    <button id="close-add-property-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Property Title</label>
                    <input type="text" id="property-title" class="w-full p-3 border rounded-lg"
                        placeholder="e.g. Lekki Phase 1 Land">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Price per Plot (₦)</label>
                    <input type="number" id="property-price" class="w-full p-3 border rounded-lg"
                        placeholder="Enter price per plot">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Size (SQM)</label>
                    <input type="number" id="property-sqm" class="w-full p-3 border rounded-lg"
                        placeholder="Enter size in square meters">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Location</label>
                    <input type="text" id="property-location" class="w-full p-3 border rounded-lg"
                        placeholder="Enter location">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Description</label>
                    <textarea id="property-description" class="w-full p-3 border rounded-lg" rows="3"
                        placeholder="Enter property description"></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Image URL</label>
                    <input type="text" id="property-image" class="w-full p-3 border rounded-lg"
                        placeholder="Enter image URL">
                </div>

                <button id="submit-property"
                    class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Add Property
                </button>

                <div id="property-message" class="hidden mt-4 p-3 rounded-lg text-center"></div>
            </div>
        </div>
    </div>

    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md auth-form">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-green-800">Upload Payment Receipt</h2>
                    <button id="close-receipt-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Pay via Bank Transfer:</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Bank Name:</span>
                            <span class="font-medium text-gray-900">United Bank Of Africa</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Account Name:</span>
                            <div class="flex items-center space-x-2">
                                <span id="bank-account-name" class="font-medium text-gray-900">Prince Kaka Global
                                    Resources</span>
                                <i id="copy-account-name-btn"
                                    class="far fa-copy text-gray-500 cursor-pointer hover:text-green-700"
                                    title="Copy Account Name"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Account Number:</span>
                            <div class="flex items-center space-x-2">
                                <span id="bank-account-number" class="font-medium text-gray-900">1028081103</span>
                                <i id="copy-account-number-btn"
                                    class="far fa-copy text-gray-500 cursor-pointer hover:text-green-700"
                                    title="Copy Account Number"></i>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-center text-red-600 mt-4">After payment, please fill the form below and
                        upload your receipt.</p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Select Property</label>
                    <select id="receipt-property-select" class="w-full p-3 border rounded-lg">
                        <option value="">-- Select Available Property --</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Price per Plot (₦)</label>
                        <input type="number" id="receipt-price-per-plot"
                            class="w-full p-3 border rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Number of Plots</label>
                        <input type="number" id="receipt-plots" class="w-full p-3 border rounded-lg"
                            placeholder="Enter plots" min="1">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Upload Receipt</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <input type="file" id="receipt-file" accept="image/*,.pdf" class="hidden">
                        <div id="receipt-preview" class="hidden mb-2">
                            <img id="receipt-preview-image" src="#" alt="Receipt preview" class="max-h-40 mx-auto">
                        </div>
                        <button id="choose-receipt"
                            class="bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200 transition">
                            <i class="fas fa-cloud-upload-alt mr-2"></i> Choose File
                        </button>
                        <p class="text-sm text-gray-500 mt-2">PNG, JPG, or PDF (Max 5MB)</p>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Actual Amount Paid (₦)</label>
                    <input type="number" id="receipt-amount" class="w-full p-3 border rounded-lg"
                        placeholder="Enter amount paid">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Payment Date</label>
                    <input type="date" id="receipt-date" class="w-full p-3 border rounded-lg">
                </div>

                <button id="submit-receipt"
                    class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition flex items-center justify-center">
                    <i class="fas fa-upload mr-2"></i> Submit for Verification
                </button>

                <div id="receipt-message" class="hidden mt-4 p-3 rounded-lg text-center"></div>
            </div>
        </div>
    </div>

    <div id="terms-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[80vh] overflow-y-auto m-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-green-800">NaijaLand - Privacy Policy & Terms of Use</h2>
                    <button id="close-terms-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="prose max-w-none">
                    <p class="mb-4">
                        Welcome to NaijaLand, a PropTech platform developed by Prince Kaka Global Resources, designed to
                        simplify digital land transactions and investment management in Nigeria. By using this platform,
                        you agree to the following terms, policies, and conditions of use.
                    </p>

                    <h3 class="font-bold text-lg mb-2">1. Privacy Policy</h3>
                    <p class="mb-4">
                        NaijaLand is committed to protecting your personal information. This Privacy Policy explains how
                        we collect, use, and safeguard the data you provide.
                    </p>

                    <h4 class="font-bold mb-2">1.1 Information We Collect</h4>
                    <ul class="list-disc pl-5 mb-4">
                        <li>Personal data such as your name, email, phone number, and location</li>
                        <li>Login credentials through Firebase Authentication</li>
                        <li>Payment details (processed securely via Paystack or UBA bank account)</li>
                        <li>Property interest and purchase records</li>
                    </ul>

                    <h4 class="font-bold mb-2">1.2 How We Use Your Information</h4>
                    <ul class="list-disc pl-5 mb-4">
                        <li>To process and confirm your land transactions</li>
                        <li>To provide access to your personal dashboard</li>
                        <li>To send updates, offers, or important notices</li>
                        <li>To ensure compliance with legal or regulatory requirements</li>
                    </ul>

                    <h4 class="font-bold mb-2">1.3 Data Protection</h4>
                    <p class="mb-4">
                        We use industry-standard security practices to protect your data. Sensitive information such as
                        payment details is encrypted and processed through secure channels only.
                    </p>

                    <h4 class="font-bold mb-2">1.4 Third-Party Services</h4>
                    <p class="mb-4">
                        We may integrate with third-party services (e.g., Google Sheets, Firebase, Paystack). These
                        services have their own privacy policies which we encourage you to review.
                    </p>

                    <h3 class="font-bold text-lg mb-2">2. Terms of Use</h3>
                    <p class="mb-4">
                        By accessing or using NaijaLand, you agree to the following terms:
                    </p>

                    <h4 class="font-bold mb-2">2.1 Property Verification</h4>
                    <p class="mb-4">
                        All land properties listed are verified and have proper documentation.
                    </p>

                    <h4 class="font-bold mb-2">2.2 Payments</h4>
                    <p class="mb-4">
                        Payments are processed securely via Paystack or UBA bank account. Ensure you receive a
                        confirmation email or WhatsApp message after payment.
                    </p>

                    <h4 class="font-bold mb-2">2.3 Documentation and Delivery</h4>
                    <p class="mb-4">
                        Property documents will be transferred to the buyer within 30 days of full payment, subject to
                        clearance of all required verification steps.
                    </p>

                    <h4 class="font-bold mb-2">2.4 Finality of Sale</h4>
                    <p class="mb-4">
                        All sales are final. Buyers are advised to verify all property details, location, and
                        documentation before completing their purchase.
                    </p>

                    <h4 class="font-bold mb-2">2.5 Platform Role</h4>
                    <p class="mb-4">
                        NaijaLand is an intermediary platform facilitating digital transactions. We are not liable for
                        any disputes arising after property documentation has been transferred to the buyer.
                    </p>

                    <h4 class="font-bold mb-2">2.6 Resale Policy</h4>
                    <p class="mb-4">
                        For resale of properties purchased via our platform, a 5% commission is charged to cover
                        administrative and marketing costs.
                    </p>

                    <h3 class="font-bold text-lg mb-2">3. Policies</h3>

                    <h4 class="font-bold mb-2">3.2 Inspection Policy</h4>
                    <p class="mb-4">
                        Free site inspections are available Monday to Saturday at 10:00 AM and 2:00 PM for Clients that
                        want to see the property before making payment.
                        <br><br>
                        Clients are strongly advised to inspect the property before any financial commitment.
                        <br><br>
                        Failure to inspect absolves NaijaLand of responsibility for post-purchase disputes related to
                        land condition or expectations.
                    </p>

                    <h4 class="font-bold mb-2">3.3 Payment Policy</h4>
                    <p class="mb-4">
                        All payments must be made only to officially designated bank accounts or approved marketing
                        partners.
                        <br><br>
                        Cash payments to agents are strictly prohibited.
                    </p>

                    <h4 class="font-bold mb-2">3.4 Additional Fees</h4>
                    <p class="mb-4">
                        Development Fee: The development fee varies depending on the location of the land and the
                        proposed time of development. This fee typically covers traditional/community settlements and
                        must be fully paid before any construction activities can begin.
                    </p>

                    <h4 class="font-bold mb-2">3.5 Construction Terms</h4>
                    <ul class="list-disc pl-5 mb-4">
                        <li>Development Fee must be paid before initiating any building works</li>
                        <li>Buyers must show evidence of active possession (e.g., fencing or clearing) within 6–12
                            months of allocation</li>
                    </ul>

                    <h4 class="font-bold mb-2">3.6 Refund Policy</h4>
                    <p class="mb-4">
                        Refunds are only granted under the following conditions:
                        <br><br>
                        Request is made before physical inspection and payment
                        <br><br>
                        Buyer provides a written discontinuation request with a 100-day processing notice via email
                    </p>

                    <h4 class="font-bold mb-2">3.7 Post-Payment Documentation</h4>
                    <p class="mb-4">
                        Upon completing full payment, buyers receive:
                    </p>
                    <ul class="list-disc pl-5 mb-4">
                        <li>Sales Receipt</li>
                        <li>Contract of Sale (for installment plans)</li>
                        <li>Title Documents</li>
                        <li>Deed of Conveyance</li>
                        <li>Registered Survey Plan</li>
                        <li>Irrevocable Power of Attorney</li>
                    </ul>

                    <h4 class="font-bold mb-2">3.8 Legal & Compliance Notice</h4>
                    <p class="mb-4">
                        NaijaLand complies with Nigerian AML/CFT laws and does not support or permit illegal
                        transactions
                        <br><br>
                        We are not responsible for misrepresentation or misconduct by independent realtors or agents
                    </p>

                    <h4 class="font-bold mb-2">3.9 Client Responsibility</h4>
                    <ul class="list-disc pl-5 mb-4">
                        <li>Buyers must verify all details before signing</li>
                        <li>If a third party is signing on the buyer's behalf, a signed authorization letter with name,
                            date, and phone number is required</li>
                        <li>Buyers confirm that all provided information is accurate and voluntarily given</li>
                    </ul>

                    <h4 class="font-bold mb-2">3.10 Land Status</h4>
                    <p class="mb-4">
                        All land is free from encumbrances, government acquisition, or adverse claims
                    </p>

                    <h3 class="font-bold text-lg mb-2">4. Additional Notes</h3>
                    <ul class="list-disc pl-5 mb-4">
                        <li>Special requests will be considered on a case-by-case basis</li>
                        <li>NaijaLand bears no responsibility for disputes arising from failure to inspect the property
                            before purchase</li>
                    </ul>

                    <h3 class="font-bold text-lg mb-2">5. Contact Us</h3>
                    <p class="mb-2">📱 WhatsApp: 08160952082</p>
                    <p class="mb-2">📧 Email: smartprincenet@gmail.com</p>
                    <p class="mb-4">🏢 Head Office: Awka, Anambra State</p>

                    <p class="mb-4">
                        By using NaijaLand, you confirm that you understand and agree to all terms stated in this
                        Privacy Policy and Terms of Use. We reserve the right to update this agreement at any time
                        without prior notice.
                    </p>
                </div>

                <div class="mt-6">
                    <button id="accept-terms"
                        class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition">
                        I Accept the Terms & Conditions
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="payment-choice-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm auth-form">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-green-800">Choose Payment Method</h2>
                    <button id="close-payment-choice-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="text-center mb-6">
                    <p>How would you like to pay for <strong id="choice-property-title">this property</strong>?</p>
                </div>
                <div class="space-y-4">
                    <button id="choice-paystack-btn"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center text-lg">
                        <i class="fas fa-credit-card mr-3"></i> Pay with Paystack (Online)
                    </button>
                    <button id="choice-transfer-btn"
                        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center text-lg">
                        <i class="fas fa-university mr-3"></i> Pay via Bank Transfer
                    </button>
                </div>
                <div class="mt-6 text-center text-sm text-gray-600">
                    <p><i class="fas fa-info-circle mr-1"></i>You will be directed to the appropriate section based on
                        your
                        choice.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // DOM Elements
        const app = {
            // Auth elements
            authModal: document.getElementById('auth-modal'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            forgotPasswordForm: document.getElementById('forgot-password-form'),
            authLoading: document.getElementById('auth-loading'),
            authMessage: document.getElementById('auth-message'),

            // View toggles
            publicView: document.getElementById('public-view'),
            privateDashboard: document.getElementById('private-dashboard'),

            // Property listing
            propertyList: document.getElementById('property-list'),
            dashboardPropertyList: document.getElementById('dashboard-property-list'),
            myInvestmentsList: document.getElementById('my-investments-list'),

            // Calculator
            calculatorResult: document.getElementById('calculator-result'),

            // Profile
            editProfileModal: document.getElementById('edit-profile-modal'),

            // Payment
            paymentModal: document.getElementById('payment-modal'),

            // Sell property
            sellPropertyModal: document.getElementById('sell-property-modal'),

            // DOWN - Add the new payment choice modal reference
            paymentChoiceModal: document.getElementById('payment-choice-modal'),

            // Admin
            adminControls: document.getElementById('admin-controls'),
            addPropertyModal: document.getElementById('add-property-modal'),

            // Terms
            termsModal: document.getElementById('terms-modal'),

            // Receipt
            receiptModal: document.getElementById('receipt-modal'),

            // Property loading states
            propertyLoading: document.getElementById('property-loading'),
            propertyReload: document.getElementById('property-reload'),
            reloadPropertiesBtn: document.getElementById('reload-properties-btn'),

            // Buttons
            loginBtn: document.getElementById('login-btn'),
            navLinks: document.getElementById('nav-links')
        };

        // Pagination variables
        const pagination = {
            currentPage: 1,
            itemsPerPage: 6,
            totalItems: 0,
            totalPages: 1
        };

        // Paystack Configuration
        const paystack = {
            publicKey: 'pk_live_87802cb3f016f04f2b8b797eb69e4e8cc68f0bce', // Your Paystack LIVE public key
        };

        // ===================================
        // NEW FUNCTION TO UPDATE META TAGS
        // ===================================
        function updateMetaTags(property) {
            if (property) {
                // Update title
                document.title = `${property.title} - For Sale in ${property.location} | Naijaland`;

                // Update meta description
                let descriptionTag = document.querySelector('meta[name="description"]');
                if (descriptionTag) {
                    descriptionTag.setAttribute('content', `Affordable land for sale: ${property.title} in ${property.location}. Size: ${property.sqm} SQM. Price: ₦${property.price.toLocaleString()}. Buy verified property on Naijaland.`);
                }

                // Update meta keywords
                let keywordsTag = document.querySelector('meta[name="keywords"]');
                if (keywordsTag) {
                    keywordsTag.setAttribute('content', `land for sale in ${property.location}, ${property.title}, buy land in Nigeria, affordable land, Naijaland`);
                }

                // Update Open Graph tags for social media sharing
                let ogTitle = document.querySelector('meta[property="og:title"]');
                if (ogTitle) {
                    ogTitle.setAttribute('content', `${property.title} - For Sale in ${property.location} | Naijaland`);
                }

                let ogDescription = document.querySelector('meta[property="og:description"]');
                if (ogDescription) {
                    ogDescription.setAttribute('content', `Affordable land for sale: ${property.title} in ${property.location}. Size: ${property.sqm} SQM. Price: ₦${property.price.toLocaleString()}.`);
                }

                let ogImage = document.querySelector('meta[property="og:image"]');
                if (ogImage) {
                    ogImage.setAttribute('content', property.image);
                }

                let ogUrl = document.querySelector('meta[property="og:url"]');
                if (ogUrl) {
                    // Point the URL to the new property detail page
                    ogUrl.setAttribute('content', `${window.location.origin}/property.html?id=${property.id}`);
                }

                // Update Twitter Card tags
                let twitterTitle = document.querySelector('meta[property="twitter:title"]');
                if (twitterTitle) {
                    twitterTitle.setAttribute('content', `${property.title} - For Sale in ${property.location} | Naijaland`);
                }

                let twitterDescription = document.querySelector('meta[property="twitter:description"]');
                if (twitterDescription) {
                    twitterDescription.setAttribute('content', `Affordable land for sale: ${property.title} in ${property.location}. Size: ${property.sqm} SQM. Price: ₦${property.price.toLocaleString()}.`);
                }

                let twitterImage = document.querySelector('meta[property="twitter:image"]');
                if (twitterImage) {
                    twitterImage.setAttribute('content', property.image);
                }
            }
        }

        // ======================
        // Firestore Property CRUD
        // ======================

        async function getProperties(filters = {}) {
            try {
                let query = db.collection('properties');

                // Apply status filter if provided, otherwise default to available
                if (filters.status) {
                    query = query.where('status', '==', filters.status);
                } else {
                    query = query.where('status', '==', 'available');
                }


                if (filters.minPrice) query = query.where('price', '>=', Number(filters.minPrice));
                if (filters.maxPrice) query = query.where('price', '<=', Number(filters.maxPrice));
                if (filters.location) query = query.where('location', '==', filters.location);

                const snapshot = await query.get();
                const properties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Update pagination info
                pagination.totalItems = properties.length;
                pagination.totalPages = Math.ceil(pagination.totalItems / pagination.itemsPerPage);

                return properties;
            } catch (error) {
                console.error("Error getting properties:", error);
                showToast("Error loading properties", "error");
                return [];
            }
        }

        async function getUniqueLocations() {
            try {
                const snapshot = await db.collection('properties').get();
                const locations = new Set();

                snapshot.forEach(doc => {
                    const property = doc.data();
                    if (property.location) {
                        locations.add(property.location);
                    }
                });

                return Array.from(locations).sort();
            } catch (error) {
                console.error("Error getting locations:", error);
                return [];
            }
        }

        async function getProperty(id) {
            try {
                const doc = await db.collection('properties').doc(id).get();
                return doc.exists ? { id: doc.id, ...doc.data() } : null;
            } catch (error) {
                console.error("Error getting property:", error);
                showToast("Error loading property details", "error");
                return null;
            }
        }

        // ======================
        // Firestore Investment CRUD
        // ======================

        async function getUserInvestments(userId) {
            try {
                const snapshot = await db.collection('investments')
                    .where('userId', '==', userId)
                    .get();

                return snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    purchaseDate: doc.data().purchaseDate?.toDate().toLocaleDateString()
                }));
            } catch (error) {
                console.error("Error getting investments:", error);
                showToast("Error loading your investments", "error");
                return [];
            }
        }

        async function addInvestmentWithTransaction(userId, propertyId, title, price, plots, location, reference) {
            const db = firebase.firestore();

            try {
                await db.runTransaction(async (transaction) => {
                    // 1. Check if property is still available
                    const propertyRef = db.collection('properties').doc(propertyId);
                    const propertyDoc = await transaction.get(propertyRef);

                    if (!propertyDoc.exists) {
                        throw new Error("Property no longer exists");
                    }

                    const propertyData = propertyDoc.data();

                    if (propertyData.status !== 'available') {
                        throw new Error("Property is no longer available");
                    }

                    // 2. Update property status to 'pending' temporarily
                    transaction.update(propertyRef, {
                        status: 'pending'
                    });

                    // 3. Create the investment record
                    const investmentRef = db.collection('investments').doc();
                    transaction.set(investmentRef, {
                        userId: userId,
                        propertyId: propertyId,
                        title: title,
                        purchasePrice: price,
                        purchaseDate: firebase.firestore.FieldValue.serverTimestamp(),
                        plots: plots,
                        location: location,
                        status: "owned",
                        paymentReference: reference
                    });

                    // 4. Finalize by setting property status to 'sold'
                    transaction.update(propertyRef, {
                        status: 'sold',
                        soldTo: userId,
                        soldAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                console.log("Transaction successfully completed!");
                return true;
            } catch (error) {
                console.error("Transaction failed: ", error);

                // Show error to user
                showToast(`Purchase failed: ${error.message}`, 'error');

                // In a real app, you might want to initiate a refund here
                return false;
            }
        }

        async function cleanupPendingProperties() {
            try {
                const snapshot = await db.collection('properties')
                    .where('status', '==', 'pending')
                    .where('updatedAt', '<', new Date(Date.now() - 30 * 60 * 1000)) // 30 minutes old
                    .get();

                const batch = db.batch();

                snapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        status: 'available',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();
                console.log(`Cleaned up ${snapshot.size} pending properties`);
            } catch (error) {
                console.error("Error cleaning up pending properties:", error);
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function () {
            // Load properties
            loadProperties();

            // Populate location filter
            populateLocationFilter();

            // Check auth state
            auth.onAuthStateChanged(async user => {
                if (user) {
                    try {
                        // User is signed in
                        await showPrivateDashboard(user);

                        // Check if user is admin
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists && userDoc.data().isAdmin) {
                            app.adminControls.classList.remove('hidden');
                            cleanupPendingProperties();
                        }
                    } catch (error) {
                        console.error("Error loading dashboard:", error);
                        showToast("Error loading dashboard", "error");
                    }
                } else {
                    // No user is signed in
                    showPublicView();
                }
            });

            // Setup event listeners
            setupEventListeners();
        });

        async function populateLocationFilter() {
            const locations = await getUniqueLocations();
            const locationSelect = document.getElementById('filter-location');

            // Clear existing options except the first one
            while (locationSelect.options.length > 1) {
                locationSelect.remove(1);
            }

            // Add new location options
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });
        }

        // Render properties to the public view with pagination
        async function renderProperties(properties, isDashboard = false) {
            const targetList = isDashboard ? app.dashboardPropertyList : app.propertyList;
            const paginationContainer = isDashboard ? document.getElementById('dashboard-pagination') : document.getElementById('pagination');
            const pageNumbersContainer = isDashboard ? document.getElementById('dashboard-page-numbers') : document.getElementById('page-numbers');
            const prevButton = isDashboard ? document.getElementById('dashboard-prev-page') : document.getElementById('prev-page');
            const nextButton = isDashboard ? document.getElementById('dashboard-next-page') : document.getElementById('next-page');

            // Clear existing properties
            targetList.innerHTML = '';

            if (!properties || properties.length === 0) {
                targetList.innerHTML = '<div class="text-center py-8 text-gray-500 col-span-full"><i class="fas fa-folder-open text-4xl mb-2"></i><p>No properties found, refresh the page</p></div>';
                paginationContainer.classList.add('hidden');
                return;
            }

            // Calculate pagination
            const startIndex = (pagination.currentPage - 1) * pagination.itemsPerPage;
            const endIndex = Math.min(startIndex + pagination.itemsPerPage, properties.length);
            const paginatedItems = properties.slice(startIndex, endIndex);

            // Render properties
            paginatedItems.forEach(property => {
                // Format price with commas
                const formattedPrice = new Intl.NumberFormat('en-NG', {
                    style: 'currency',
                    currency: 'NGN'
                }).format(property.price).replace('NGN', '₦');

                // Create property card
                const card = document.createElement('div');
                card.className = 'property-card bg-white rounded-lg overflow-hidden shadow-md transition duration-300';
                card.innerHTML = `
    <div class="lazy-image w-full h-48 overflow-hidden">
        <img src="${property.image}" alt="${property.title}" class="w-full h-full object-cover" loading="lazy">
    </div>
    <div class="p-4">
        <h3 class="text-xl font-bold text-green-800 mb-2">${property.title}</h3>
        <div class="flex justify-between mb-2">
            <span class="text-gray-700">
                <i class="fas fa-map-marker-alt mr-1 text-green-600"></i> ${property.location}
            </span>
            <span class="text-gray-700">
                <i class="fas fa-ruler-combined mr-1 text-green-600"></i> ${property.sqm} SQM
            </span>
        </div>
        <p class="text-gray-600 text-sm mb-4">${property.description}</p>
        <div class="flex justify-between items-center">
            <span class="text-xl font-bold text-green-700">${formattedPrice}</span>
            <div class="flex items-center space-x-2">
                <a href="/property.html?id=${property.id}" class="view-details bg-gray-200 text-gray-800 px-3 py-2 rounded-lg hover:bg-gray-300 transition text-sm" data-id="${property.id}">
                    View Details
                </a>
                <a href="https://wa.me/2348160952082?text=I'd like to book an inspection for ${encodeURIComponent(property.title)}" 
                    target="_blank" 
                    class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition text-sm flex items-center">
                    <i class="fab fa-whatsapp mr-2"></i>
                    <span>Book Inspection</span>
                </a>
            </div>
        </div>
    </div>
`;
                if (!isDashboard) {
                    app.propertyList.appendChild(card.cloneNode(true));
                }

                // Dashboard version has payment button
                const dashboardCard = card.cloneNode(true);
                // Target the parent container of both the price and buttons
                const priceAndButtonContainer = dashboardCard.querySelector('.flex.justify-between.items-center');
                priceAndButtonContainer.innerHTML = `
    <span class="text-xl font-bold text-green-700">${formattedPrice}</span>
    <div class="flex space-x-2">
        <a href="https://wa.me/2348160952082?text=I'd like to book an inspection for ${encodeURIComponent(property.title)}" target="_blank" class="bg-green-100 text-green-700 px-3 py-2 rounded-lg hover:bg-green-200 transition text-sm">
            Book Inspection
        </a>
        ${property.status === 'available' ? `
            <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition pay-button" data-id="${property.id}">
                <i class="fas fa-credit-card mr-1"></i> Buy
            </button>
        ` : `
            <button class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed" disabled>
                ${property.status === 'pending' || property.status === 'pending verification' ? 'Processing...' : 'Sold'}
            </button>
        `}
    </div>
`;


                if (isDashboard) {
                    app.dashboardPropertyList.appendChild(dashboardCard);
                }
            });

            // Update pagination controls
            updatePaginationControls(isDashboard);

            // Populate property dropdowns in calculator and payment modal
            if (!isDashboard) {
                populatePropertyDropdowns(properties);
            }
        }

        // Update pagination controls
        function updatePaginationControls(isDashboard = false) {
            const paginationContainer = isDashboard ? document.getElementById('dashboard-pagination') : document.getElementById('pagination');
            const pageNumbersContainer = isDashboard ? document.getElementById('dashboard-page-numbers') : document.getElementById('page-numbers');
            const prevButton = isDashboard ? document.getElementById('dashboard-prev-page') : document.getElementById('prev-page');
            const nextButton = isDashboard ? document.getElementById('dashboard-next-page') : document.getElementById('next-page');

            // Show/hide pagination based on total pages
            if (pagination.totalPages > 1) {
                paginationContainer.classList.remove('hidden');

                // Update prev/next buttons
                prevButton.disabled = pagination.currentPage === 1;
                nextButton.disabled = pagination.currentPage === pagination.totalPages;

                // Update page numbers
                pageNumbersContainer.innerHTML = '';

                const maxVisiblePages = 5;
                let startPage = Math.max(1, pagination.currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(pagination.totalPages, startPage + maxVisiblePages - 1);

                // Adjust if we're at the end
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                // Add page numbers
                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.className = `px-4 py-2 ${i === pagination.currentPage ? 'bg-green-700 text-white' : 'bg-gray-200'} mx-1`;
                    pageButton.textContent = i;
                    pageButton.addEventListener('click', () => {
                        pagination.currentPage = i;
                        loadProperties();
                    });
                    pageNumbersContainer.appendChild(pageButton);
                }
            } else {
                paginationContainer.classList.add('hidden');
            }
        }

        // Populate property dropdowns in calculator and payment modal
        function populatePropertyDropdowns(properties) {
            const calculatorSelect = document.getElementById('calculator-property');
            const paymentSelect = document.getElementById('payment-property');

            // Clear existing options
            calculatorSelect.innerHTML = '<option value="">-- Select Property --</option>';
            paymentSelect.innerHTML = '<option value="">-- Select Property --</option>';

            // Add properties to both dropdowns
            properties.forEach(property => {
                if (property.status === 'available') {
                    const option = document.createElement('option');
                    option.value = property.id;
                    option.textContent = `${property.title} (₦${property.price.toLocaleString()})`;
                    option.dataset.pricePerPlot = property.price;

                    calculatorSelect.appendChild(option.cloneNode(true));
                    paymentSelect.appendChild(option);
                }
            });

            // Add event listeners
            calculatorSelect.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('price-per-plot').value = selectedOption.dataset.pricePerPlot;
                } else {
                    document.getElementById('price-per-plot').value = '';
                }
            });

            paymentSelect.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('payment-price-per-plot').value = selectedOption.dataset.pricePerPlot;
                    calculatePaymentAmount();
                } else {
                    document.getElementById('payment-price-per-plot').value = '';
                    document.getElementById('payment-amount').value = '';
                }
            });

            // Add input event for SQM in payment modal
            document.getElementById('payment-plots').addEventListener('input', calculatePaymentAmount);
        }

        // Calculate amount in payment modal
        function calculatePaymentAmount() {
            const pricePerPlot = parseFloat(document.getElementById('payment-price-per-plot').value);
            const plots = parseFloat(document.getElementById('payment-plots').value);

            if (!isNaN(pricePerPlot) && !isNaN(plots) && plots > 0) {
                const amount = pricePerPlot * plots;
                document.getElementById('payment-amount').value = amount.toFixed(2);

                // Enable/disable payment button based on minimum amount
                const paymentButton = document.getElementById('initiate-payment');
                paymentButton.disabled = amount < 100000;

                if (amount < 100000) {
                    showPaymentMessage('Minimum amount is ₦100,000', 'error');
                } else {
                    document.getElementById('payment-message').classList.add('hidden');
                }
            }
        }

        // Render user's investments
        async function renderInvestments(userId) {
            const investments = await getUserInvestments(userId);
            app.myInvestmentsList.innerHTML = '';

            if (investments.length === 0) {
                app.myInvestmentsList.innerHTML = `
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-folder-open text-4xl mb-2"></i>
                                    <p>You don't have any land investments yet</p>
                                </div>
                            `;
                return;
            }

            investments.forEach(investment => {
                // Format price with commas
                const formattedPrice = new Intl.NumberFormat('en-NG', {
                    style: 'currency',
                    currency: 'NGN'
                }).format(investment.purchasePrice).replace('NGN', '₦');

                // Determine status badge
                let statusBadge;
                switch (investment.status) {
                    case 'for_sale':
                        statusBadge = '<span class="text-sm bg-yellow-100 text-yellow-800 px-2 py-1 rounded">For Sale</span>';
                        break;
                    case 'payment_verified':
                    case 'owned':
                        statusBadge = '<span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded">Owned</span>';
                        break;
                    case 'pending verification':
                        statusBadge = '<span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">Pending Verification</span>';
                        break;
                    default:
                        statusBadge = `<span class="text-sm bg-gray-100 text-gray-800 px-2 py-1 rounded">${investment.status}</span>`;
                }

                // Create investment card
                const card = document.createElement('div');
                card.className = 'owned-property bg-white p-4 rounded-lg shadow-md transition duration-300';
                card.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-lg font-bold text-green-800">${investment.title}</h3>
                                    ${statusBadge}
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div>
                                        <p class="text-sm text-gray-500">Purchase Price</p>
                                        <p class="font-medium">${formattedPrice}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Purchase Date</p>
                                        <p class="font-medium">${investment.purchaseDate}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Plots</p>
                                        <p class="font-medium">${investment.plots || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Location</p>
                                        <p class="font-medium">${investment.location}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    ${(investment.status === 'owned' || investment.status === 'payment_verified') ? `
                                        <button class="sell-property bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200 transition text-sm" data-id="${investment.id}">
                                            <i class="fas fa-hand-holding-usd mr-1"></i> Sell
                                        </button>
                                    ` : ''}
                                    <button class="view-investment-details bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200 transition text-sm" data-id="${investment.propertyId}">
                                        <i class="fas fa-eye mr-1"></i> View Details
                                    </button>
                                </div>
                                <div class="mt-3 pt-3 border-t">
                                    ${investment.receipt ? `
                                        <p class="text-sm text-gray-500">Payment Verified</p>
                                        <button class="view-receipt bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200 transition text-sm mt-2" data-id="${investment.id}">
                                            <i class="fas fa-receipt mr-1"></i> View Receipt
                                        </button>
                                    ` : `
                                        <p class="text-sm text-gray-500">Pending Verification</p>
                                    `}
                                </div>
                            `;

                app.myInvestmentsList.appendChild(card);
            });

            // Populate sell property select
            const sellPropertySelect = document.getElementById('sell-property-select');
            sellPropertySelect.innerHTML = '<option value="">-- Select Property --</option>';
            investments.forEach(investment => {
                if (investment.status !== 'for_sale') {
                    const option = document.createElement('option');
                    option.value = investment.id;
                    option.textContent = `${investment.title} (₦${investment.purchasePrice.toLocaleString()})`;
                    sellPropertySelect.appendChild(option);
                }
            });
        }

        // Show public view
        function showPublicView() {
            app.publicView.classList.remove('hidden');
            app.privateDashboard.classList.add('hidden');
            app.loginBtn.textContent = 'Login / Register';
            app.loginBtn.onclick = showLoginModal;
        }

        // Show private dashboard
        async function showPrivateDashboard(user) {
            app.publicView.classList.add('hidden');
            app.privateDashboard.classList.remove('hidden');

            // Show loading state for properties
            app.dashboardPropertyList.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p>Loading properties...</p></div>';
            app.myInvestmentsList.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p>Loading your investments...</p></div>';

            // 1. First update user info
            document.getElementById('user-name').textContent = user.displayName || 'User';
            document.getElementById('account-name').textContent = user.displayName || 'Not set';
            document.getElementById('account-email').textContent = user.email;

            // Get additional user data from Firestore
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('account-phone').textContent = userData.phone || 'Not set';
                    document.getElementById('account-location').textContent = userData.location || 'Not set';
                }

                // 2. Then load user's investments
                await renderInvestments(user.uid);

                // 3. Finally load and render properties
                loadProperties(true);

            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showToast("Error loading dashboard data", "error");
            }

            // Update nav
            app.loginBtn.textContent = 'Logout';
            app.loginBtn.onclick = () => auth.signOut();
        }

        // Load properties with pagination
        async function loadProperties(isDashboard = false) {
            // Only show loading state for the public view
            if (!isDashboard) {
                app.propertyLoading.classList.remove('hidden');
                app.propertyReload.classList.add('hidden');
                app.propertyList.classList.add('hidden'); // Hide the list while loading
            }

            try {
                const properties = await getProperties();
                renderProperties(properties, isDashboard);

                // Hide loading state on success
                if (!isDashboard) {
                    app.propertyLoading.classList.add('hidden');
                    app.propertyList.classList.remove('hidden'); // Show the list with properties
                }
            } catch (error) {
                console.error("Error loading properties:", error);
                showToast("Error loading properties", "error");

                // Show reload option on error
                if (!isDashboard) {
                    app.propertyLoading.classList.add('hidden');
                    app.propertyReload.classList.remove('hidden');
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth modal toggles
            document.getElementById('show-register').addEventListener('click', showRegisterModal);
            document.getElementById('show-login').addEventListener('click', showLoginModal);
            document.getElementById('show-login-from-forgot').addEventListener('click', showLoginModal);
            document.getElementById('show-forgot-password').addEventListener('click', showForgotPasswordModal);
            document.getElementById('close-auth-modal').addEventListener('click', () => app.authModal.classList.add('hidden'));

            // Auth form submissions
            document.getElementById('login-submit').addEventListener('click', loginUser);
            document.getElementById('register-submit').addEventListener('click', registerUser);
            document.getElementById('forgot-submit').addEventListener('click', sendPasswordReset);

            // Edit profile
            document.getElementById('edit-profile').addEventListener('click', showEditProfileModal);
            document.getElementById('close-edit-modal').addEventListener('click', () => app.editProfileModal.classList.add('hidden'));
            document.getElementById('save-profile').addEventListener('click', saveProfile);

            // Payment
            document.getElementById('paystack-button').addEventListener('click', () => app.paymentModal.classList.remove('hidden'));
            document.getElementById('close-payment-modal').addEventListener('click', () => app.paymentModal.classList.add('hidden'));
            document.getElementById('initiate-payment').addEventListener('click', processPayment);

            // Sell property
            document.getElementById('close-sell-modal').addEventListener('click', () => app.sellPropertyModal.classList.add('hidden'));
            document.getElementById('submit-sale').addEventListener('click', listPropertyForSale);

            // DOWN - Add event listeners for the new payment choice modal
            document.getElementById('close-payment-choice-modal').addEventListener('click', () => app.paymentChoiceModal.classList.add('hidden'));
            document.getElementById('choice-paystack-btn').addEventListener('click', (e) => {
                const propertyId = e.currentTarget.dataset.propertyId;
                app.paymentChoiceModal.classList.add('hidden'); // Hide the choice modal

                // Now, trigger the original Paystack payment modal
                getProperty(propertyId).then(property => {
                    if (property) {
                        document.getElementById('payment-property').value = property.id;
                        document.getElementById('payment-price-per-plot').value = property.price;
                        document.getElementById('payment-plots').value = '1'; // Default to 1 plot
                        calculatePaymentAmount(); // Calculate the total amount
                        document.getElementById('payment-email').value = auth.currentUser?.email || '';
                        app.paymentModal.classList.remove('hidden'); // Show the Paystack modal
                    }
                });
            });
            document.getElementById('choice-transfer-btn').addEventListener('click', (e) => {
                const propertyId = e.currentTarget.dataset.propertyId;
                app.paymentChoiceModal.classList.add('hidden'); // Hide the choice modal

                // Now, trigger the existing "Upload Receipt" modal
                showReceiptModal();

                // Pre-select the property in the receipt modal
                // We need a slight delay for the property list to populate in showReceiptModal
                setTimeout(() => {
                    const receiptPropertySelect = document.getElementById('receipt-property-select');
                    if (receiptPropertySelect) {
                        receiptPropertySelect.value = propertyId;
                        // Manually trigger the 'onchange' event to update the price fields
                        const event = new Event('change');
                        receiptPropertySelect.dispatchEvent(event);
                    }
                }, 500); // 500ms should be enough for properties to load
            });
            // UP

            // Admin controls
            document.getElementById('update-investments').addEventListener('click', updateAllInvestments);
            document.getElementById('add-property').addEventListener('click', () => app.addPropertyModal.classList.remove('hidden'));
            document.getElementById('close-add-property-modal').addEventListener('click', () => app.addPropertyModal.classList.add('hidden'));
            document.getElementById('submit-property').addEventListener('click', addNewProperty);

            // Calculator
            document.getElementById('calculate-price').addEventListener('click', calculateTotalPrice);
            document.getElementById('proceed-to-payment').addEventListener('click', proceedToPaymentFromCalculator);

            // Filters
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            document.getElementById('search-properties').addEventListener('input', searchProperties);

            // Reload properties button
            app.reloadPropertiesBtn.addEventListener('click', () => loadProperties());

            // Pagination
            document.getElementById('prev-page').addEventListener('click', () => {
                if (pagination.currentPage > 1) {
                    pagination.currentPage--;
                    loadProperties();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                if (pagination.currentPage < pagination.totalPages) {
                    pagination.currentPage++;
                    loadProperties();
                }
            });

            document.getElementById('dashboard-prev-page').addEventListener('click', () => {
                if (pagination.currentPage > 1) {
                    pagination.currentPage--;
                    loadProperties(true);
                }
            });

            document.getElementById('dashboard-next-page').addEventListener('click', () => {
                if (pagination.currentPage < pagination.totalPages) {
                    pagination.currentPage++;
                    loadProperties(true);
                }
            });

            // Terms and conditions
            document.getElementById('view-terms').addEventListener('click', () => app.termsModal.classList.remove('hidden'));
            document.getElementById('close-terms-modal').addEventListener('click', () => app.termsModal.classList.add('hidden'));
            document.getElementById('accept-terms').addEventListener('click', () => {
                document.getElementById('accept-terms-checkbox').checked = true;
                app.termsModal.classList.add('hidden');
                showToast('Terms & Conditions accepted', 'success');
            });

            // Receipt upload
            document.getElementById('upload-receipt').addEventListener('click', showReceiptModal);
            document.getElementById('close-receipt-modal').addEventListener('click', () => app.receiptModal.classList.add('hidden'));
            document.getElementById('choose-receipt').addEventListener('click', () => document.getElementById('receipt-file').click());
            document.getElementById('receipt-file').addEventListener('change', handleReceiptFileSelect);
            document.getElementById('submit-receipt').addEventListener('click', uploadReceipt);

            // ================================================================
            // START: THIS IS THE JAVASCRIPT CODE THAT WAS ADDED
            // It makes the copy icons interactive.
            // ================================================================

            // Copy Bank Account Name
            document.getElementById('copy-account-name-btn').addEventListener('click', () => {
                // Get the text from the span with the ID 'bank-account-name'
                const textToCopy = document.getElementById('bank-account-name').textContent;

                // Use the browser's Clipboard API to copy the text
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // If successful, show a confirmation message using the existing showToast function
                    showToast('Account Name copied!', 'success');
                }).catch(err => {
                    // If it fails, log the error and show an error message
                    console.error('Failed to copy text: ', err);
                    showToast('Failed to copy', 'error');
                });
            });

            // Copy Bank Account Number
            document.getElementById('copy-account-number-btn').addEventListener('click', () => {
                // Get the text from the span with the ID 'bank-account-number'
                const textToCopy = document.getElementById('bank-account-number').textContent;

                // Use the browser's Clipboard API to copy the text
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // If successful, show a confirmation message
                    showToast('Account Number copied!', 'success');
                }).catch(err => {
                    // If it fails, log the error and show an error message
                    console.error('Failed to copy text: ', err);
                    showToast('Failed to copy', 'error');
                });
            });

            // ================================================================
            // END OF THE ADDED JAVASCRIPT CODE
            // ================================================================


            // Password toggle
            document.querySelectorAll('.password-toggle').forEach(button => {
                button.addEventListener('click', function () {
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    if (input.type === 'password') {
                        input.type = 'text';
                        this.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    } else {
                        input.type = 'password';
                        this.innerHTML = '<i class="fas fa-eye"></i>';
                    }
                });
            });

            // Delegated event listeners for dynamic content
            document.addEventListener('click', function (e) {
                // View Details Button
                if (e.target.classList.contains('view-details') || e.target.closest('.view-details')) {

                    /* <-- ADD THIS LINE to start the comment
                    const user = auth.currentUser;
                    if (!user) {
                        showLoginModal();
                        showAuthMessage("Please log in to view property details and make a secure payment.", "info");
                    } else {
                        // Existing functionality for logged-in users
                        const button = e.target.classList.contains('view-details') ? e.target : e.target.closest('.view-details');
                        const propertyId = button.dataset.id;
                        // Implement what should happen when a logged-in user clicks "View Details"
                        // For example, show a modal with more details.
                        console.log("Viewing details for property:", propertyId);
                    }
                    */  // <-- ADD THIS LINE to end the comment
                }

                // Pay buttons
                if (e.target.classList.contains('pay-button') || e.target.closest('.pay-button')) {
                    // DOWN - New logic to show payment choice
                    const button = e.target.classList.contains('pay-button') ? e.target : e.target.closest('.pay-button');
                    const propertyId = button.dataset.id;
                    showPaymentChoiceModal(propertyId);
                    // UP
                }

                // Sell property buttons from investment list
                if (e.target.classList.contains('sell-property') || e.target.closest('.sell-property')) {
                    const button = e.target.classList.contains('sell-property') ? e.target : e.target.closest('.sell-property');
                    const investmentId = button.dataset.id;

                    document.getElementById('sell-property-select').value = investmentId;

                    const confirmSell = confirm('Are you sure you want to list this property for sale? This will open the sale details form.');
                    if (confirmSell) {
                        app.sellPropertyModal.classList.remove('hidden');
                    }
                }

                // View receipt buttons
                if (e.target.classList.contains('view-receipt') || e.target.closest('.view-receipt')) {
                    const button = e.target.classList.contains('view-receipt') ? e.target : e.target.closest('.view-receipt');
                    const investmentId = button.dataset.id;
                    viewReceipt(investmentId);
                }
            });
        }

        // Show login modal
        function showLoginModal() {
            app.authModal.classList.remove('hidden');
            app.loginForm.classList.remove('hidden');
            app.registerForm.classList.add('hidden');
            app.forgotPasswordForm.classList.add('hidden');
            app.authLoading.classList.add('hidden');
            app.authMessage.classList.add('hidden');
            document.getElementById('auth-modal-title').textContent = 'Login';
        }

        // Show register modal
        function showRegisterModal() {
            app.authModal.classList.remove('hidden');
            app.loginForm.classList.add('hidden');
            app.registerForm.classList.remove('hidden');
            app.forgotPasswordForm.classList.add('hidden');
            app.authLoading.classList.add('hidden');
            app.authMessage.classList.add('hidden');
            document.getElementById('auth-modal-title').textContent = 'Register';
        }

        // Show forgot password modal
        function showForgotPasswordModal() {
            app.authModal.classList.remove('hidden');
            app.loginForm.classList.add('hidden');
            app.registerForm.classList.add('hidden');
            app.forgotPasswordForm.classList.remove('hidden');
            app.authLoading.classList.add('hidden');
            app.authMessage.classList.add('hidden');
            document.getElementById('auth-modal-title').textContent = 'Forgot Password';
        }
        // DOWN - Add this new function to show the payment choice modal
        function showPaymentChoiceModal(propertyId) {
            getProperty(propertyId).then(property => {
                if (!property) {
                    showToast("Property details could not be loaded.", "error");
                    return;
                }

                // Store property ID and title on the modal buttons for later use
                document.getElementById('choice-paystack-btn').dataset.propertyId = propertyId;
                document.getElementById('choice-transfer-btn').dataset.propertyId = propertyId;

                // Update the modal title to be more specific
                document.getElementById('choice-property-title').textContent = property.title;

                // Show the modal
                app.paymentChoiceModal.classList.remove('hidden');
            });
        }
        // UP

        // [CORRECTED] Show receipt upload modal
        async function showReceiptModal() {
            const user = auth.currentUser;
            if (!user) {
                showLoginModal();
                showToast('Please login to upload a receipt', 'error');
                return;
            }

            app.receiptModal.classList.remove('hidden');

            // Reset form
            document.getElementById('receipt-file').value = '';
            document.getElementById('receipt-preview').classList.add('hidden');
            document.getElementById('receipt-preview').innerHTML = '<img id="receipt-preview-image" src="#" alt="Receipt preview" class="max-h-40 mx-auto">';
            document.getElementById('receipt-amount').value = '';
            document.getElementById('receipt-date').value = '';
            document.getElementById('receipt-plots').value = '';
            document.getElementById('receipt-price-per-plot').value = '';
            document.getElementById('receipt-message').classList.add('hidden');

            // Populate properties dropdown
            const select = document.getElementById('receipt-property-select');
            select.innerHTML = '<option value="">-- Loading Properties --</option>';

            try {
                const properties = await getProperties({ status: 'available' }); // Fetch only available properties
                select.innerHTML = '<option value="">-- Select Available Property --</option>';

                properties.forEach(property => {
                    const option = document.createElement('option');
                    option.value = property.id;
                    option.textContent = `${property.title} (₦${property.price.toLocaleString()}/plot)`;
                    option.dataset.price = property.price; // Store price in data attribute
                    select.appendChild(option);
                });

                if (select.options.length === 1) {
                    select.innerHTML = '<option value="">No properties available for purchase</option>';
                }
            } catch (error) {
                console.error("Error loading properties for receipt modal:", error);
                select.innerHTML = '<option value="">Error loading properties</option>';
            }

            // Add event listener to auto-fill price and calculate total
            select.onchange = function () {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('receipt-price-per-plot').value = selectedOption.dataset.price;
                    calculateReceiptAmount();
                } else {
                    document.getElementById('receipt-price-per-plot').value = '';
                    calculateReceiptAmount();
                }
            };

            document.getElementById('receipt-plots').oninput = calculateReceiptAmount;
        }

        // [NEW] Helper function to calculate amount in receipt modal
        function calculateReceiptAmount() {
            const pricePerPlot = parseFloat(document.getElementById('receipt-price-per-plot').value);
            const plots = parseFloat(document.getElementById('receipt-plots').value);
            const amountInput = document.getElementById('receipt-amount');

            if (!isNaN(pricePerPlot) && !isNaN(plots) && plots > 0) {
                const amount = pricePerPlot * plots;
                amountInput.value = amount; // Set the calculated amount
                amountInput.readOnly = true; // Make it read-only to avoid confusion
                amountInput.classList.add('bg-gray-100');
            } else {
                amountInput.value = ''; // Clear if inputs are invalid
                amountInput.readOnly = false;
                amountInput.classList.remove('bg-gray-100');
            }
        }

        // Handle file selection
        function handleReceiptFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showReceiptMessage('File size exceeds 5MB limit', 'error');
                e.target.value = ''; // Reset file input
                return;
            }

            // Check file type
            const validTypes = ['image/jpeg', 'image/png', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                showReceiptMessage('Only JPG, PNG, or PDF files are allowed', 'error');
                e.target.value = ''; // Reset file input
                return;
            }

            const preview = document.getElementById('receipt-preview');
            preview.classList.remove('hidden');

            // Show preview for images
            if (file.type.includes('image')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewImage = document.getElementById('receipt-preview-image');
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                // For PDFs, just show the filename
                preview.innerHTML = `<p class="text-sm">${file.name}</p>`;
            }
        }

        // [CORRECTED] Upload receipt to Firestore and create an investment
        async function uploadReceipt() {
            const propertyId = document.getElementById('receipt-property-select').value;
            const fileInput = document.getElementById('receipt-file');
            const amount = document.getElementById('receipt-amount').value;
            const plots = document.getElementById('receipt-plots').value;
            const date = document.getElementById('receipt-date').value;
            const user = auth.currentUser;

            if (!user) { showReceiptMessage('You must be logged in.', 'error'); return; }
            if (!propertyId) { showReceiptMessage('Please select a property.', 'error'); return; }
            if (!plots || isNaN(plots) || plots <= 0) { showReceiptMessage('Please enter a valid number of plots.', 'error'); return; }
            if (!fileInput.files[0]) { showReceiptMessage('Please select a receipt file.', 'error'); return; }
            if (!amount || isNaN(amount) || amount <= 0) { showReceiptMessage('Amount is invalid. Please check plots and price.', 'error'); return; }
            if (!date) { showReceiptMessage('Please select the payment date.', 'error'); return; }

            const file = fileInput.files[0];
            const reader = new FileReader();

            const submitButton = document.getElementById('submit-receipt');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner mx-auto"></div> Submitting...';

            try {
                const base64String = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });

                const receiptData = {
                    fileName: file.name,
                    fileType: file.type,
                    base64Data: base64String,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    amount: parseFloat(amount),
                    paymentDate: new Date(date)
                };

                const db = firebase.firestore();
                const propertyRef = db.collection('properties').doc(propertyId);
                const investmentRef = db.collection('investments').doc();

                await db.runTransaction(async (transaction) => {
                    const propertyDoc = await transaction.get(propertyRef);
                    if (!propertyDoc.exists) throw new Error("Property does not exist.");

                    const propertyData = propertyDoc.data();
                    if (propertyData.status !== 'available') throw new Error("This property is no longer available.");

                    transaction.update(propertyRef, {
                        status: 'pending verification',
                        soldTo: user.uid,
                        soldAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    transaction.set(investmentRef, {
                        userId: user.uid,
                        propertyId: propertyId,
                        title: propertyData.title,
                        location: propertyData.location,
                        plots: Number(plots),
                        purchasePrice: Number(amount),
                        purchaseDate: new Date(date),
                        status: 'pending verification',
                        receipt: receiptData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                showReceiptMessage('Receipt submitted for verification!', 'success');

                setTimeout(() => {
                    app.receiptModal.classList.add('hidden');
                    renderInvestments(user.uid);
                    loadProperties();
                    if (app.privateDashboard.classList.contains('hidden') === false) {
                        loadProperties(true);
                    }
                }, 2000);

            } catch (error) {
                console.error('Error submitting receipt:', error);
                showReceiptMessage('Error: ' + error.message, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        }

        // View receipt
        async function viewReceipt(investmentId) {
            try {
                const investmentDoc = await db.collection('investments').doc(investmentId).get();
                if (!investmentDoc.exists || !investmentDoc.data().receipt) {
                    showToast('Receipt not found', 'error');
                    return;
                }

                const receipt = investmentDoc.data().receipt;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

                const paymentDate = receipt.paymentDate.toDate().toLocaleDateString();

                if (receipt.fileType.includes('image')) {
                    modal.innerHTML = `
                                        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl auth-form">
                                            <div class="p-6">
                                                <div class="flex justify-between items-center mb-4">
                                                    <h2 class="text-2xl font-bold text-green-800">Payment Receipt</h2>
                                                    <button class="close-receipt-view text-gray-500 hover:text-gray-700">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                               
                                                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <p class="text-sm text-gray-500">Amount Paid</p>
                                                        <p class="font-medium">₦${receipt.amount.toLocaleString()}</p>
                                                    </div>
                                                    <div>
                                                        <p class="text-sm text-gray-500">Payment Date</p>
                                                        <p class="font-medium">${paymentDate}</p>
                                                    </div>
                                                </div>
                                               
                                                <div class="border rounded-lg p-2">
                                                    <img src="data:${receipt.fileType};base64,${receipt.base64Data}" alt="Payment Receipt" class="max-h-[70vh] mx-auto">
                                                </div>
                                            </div>
                                        </div>
                                    `;
                } else {
                    modal.innerHTML = `
                                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md auth-form">
                                            <div class="p-6">
                                                <div class="flex justify-between items-center mb-4">
                                                    <h2 class="text-2xl font-bold text-green-800">Payment Receipt</h2>
                                                    <button class="close-receipt-view text-gray-500 hover:text-gray-700">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                               
                                                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <p class="text-sm text-gray-500">Amount Paid</p>
                                                        <p class="font-medium">₦${receipt.amount.toLocaleString()}</p>
                                                    </div>
                                                    <div>
                                                        <p class="text-sm text-gray-500">Payment Date</p>
                                                        <p class="font-medium">${paymentDate}</p>
                                                    </div>
                                                </div>
                                               
                                                <div class="text-center py-8">
                                                    <i class="fas fa-file-pdf text-5xl text-red-500 mb-4"></i>
                                                    <p class="mb-4">PDF receipt uploaded</p>
                                                    <button class="download-receipt bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition" data-id="${investmentId}">
                                                        <i class="fas fa-download mr-2"></i> Download Receipt
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                }

                document.body.appendChild(modal);

                modal.querySelector('.close-receipt-view').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                if (!receipt.fileType.includes('image')) {
                    modal.querySelector('.download-receipt').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.href = `data:${receipt.fileType};base64,${receipt.base64Data}`;
                        link.download = `receipt_${investmentId}.pdf`;
                        link.click();
                    });
                }
            } catch (error) {
                console.error('Error viewing receipt:', error);
                showToast('Error viewing receipt', 'error');
            }
        }

        // Show receipt upload message
        function showReceiptMessage(message, type) {
            const element = document.getElementById('receipt-message');
            element.textContent = message;
            element.className = `mt-4 p-3 rounded-lg text-center ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            element.classList.remove('hidden');
        }

        // Login user
        function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showAuthMessage('Please enter both email and password', 'error');
                return;
            }

            app.authLoading.classList.remove('hidden');
            app.loginForm.classList.add('hidden');
            document.getElementById('auth-loading-text').textContent = 'Logging in...';

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // On successful login, hide the modal
                    app.authModal.classList.add('hidden');
                })
                .catch((error) => {
                    let errorMessage; // We will set the message based on the error type

                    // Check for specific, common errors from Firebase
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email address.';
                    } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        // This is the specific message you wanted
                        errorMessage = 'Incorrect password. Please try again.';
                    } else {
                        // This is a fallback for any other unexpected errors
                        errorMessage = 'Login failed. Please check your connection and try again.';
                        console.error("Firebase Login Error:", error); // Log the technical error for your own debugging
                    }

                    // Show the user-friendly error message
                    showAuthMessage(errorMessage, 'error');

                    // Hide the loading spinner and show the login form again
                    app.authLoading.classList.add('hidden');
                    app.loginForm.classList.remove('hidden');
                });
        }

        // Register user
        function registerUser() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const phone = document.getElementById('register-phone').value;
            const location = document.getElementById('register-location').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const acceptTerms = document.getElementById('accept-terms-checkbox').checked;

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) { showAuthMessage('Please enter a valid email address', 'error'); return; }

            const phoneRegex = /^[0-9]{11}$/;
            if (phone && !phoneRegex.test(phone)) { showAuthMessage('Please enter a valid 11-digit phone number', 'error'); return; }

            if (!name || !email || !password || !confirmPassword) { showAuthMessage('Please fill in all required fields', 'error'); return; }
            if (password !== confirmPassword) { showAuthMessage('Passwords do not match', 'error'); return; }
            if (password.length < 6) { showAuthMessage('Password must be at least 6 characters', 'error'); return; }
            if (!acceptTerms) { showAuthMessage('You must accept the Terms & Conditions to register', 'error'); return; }

            app.authLoading.classList.remove('hidden');
            app.registerForm.classList.add('hidden');
            document.getElementById('auth-loading-text').textContent = 'Creating account...';

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        phone: phone,
                        location: location,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        isAdmin: false,
                        acceptedTerms: true
                    }).then(() => {
                        return userCredential.user.updateProfile({
                            displayName: name
                        });
                    });
                })
                .then(() => {
                    app.authModal.classList.add('hidden');
                })
                .catch((error) => {
                    let errorMessage = error.message;
                    if (error.code === 'auth/email-already-in-use') { errorMessage = 'Email address is already in use'; }
                    else if (error.code === 'auth/invalid-email') { errorMessage = 'Email address is invalid'; }
                    else if (error.code === 'auth/weak-password') { errorMessage = 'Password is too weak'; }
                    showAuthMessage(errorMessage, 'error');
                    app.authLoading.classList.add('hidden');
                    app.registerForm.classList.remove('hidden');
                });
        }

        // Send password reset
        function sendPasswordReset() {
            const email = document.getElementById('forgot-email').value;

            if (!email) {
                showAuthMessage('Please enter your email address', 'error');
                return;
            }

            app.authLoading.classList.remove('hidden');
            app.forgotPasswordForm.classList.add('hidden');
            document.getElementById('auth-loading-text').textContent = 'Sending reset link...';

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showAuthMessage('Password reset email sent. Please check your inbox.', 'success');
                    setTimeout(() => {
                        app.authModal.classList.add('hidden');
                    }, 3000);
                })
                .catch((error) => {
                    let errorMessage = error.message;
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No user found with this email address';
                    }
                    showAuthMessage(errorMessage, 'error');
                    app.authLoading.classList.add('hidden');
                    app.forgotPasswordForm.classList.remove('hidden');
                });
        }

        // Show auth message
        function showAuthMessage(message, type) {
            app.authMessage.textContent = message;
            app.authMessage.className = `mt-4 p-3 rounded-lg text-center ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            app.authMessage.classList.remove('hidden');
        }

        // Show edit profile modal
        function showEditProfileModal() {
            const user = auth.currentUser;

            document.getElementById('edit-name').value = user.displayName || '';
            document.getElementById('edit-phone').value = document.getElementById('account-phone').textContent === 'Not set' ? '' : document.getElementById('account-phone').textContent;
            document.getElementById('edit-location').value = document.getElementById('account-location').textContent === 'Not set' ? '' : document.getElementById('account-location').textContent;

            app.editProfileModal.classList.remove('hidden');
        }

        // Save profile
        async function saveProfile() {
            const user = auth.currentUser;
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            const location = document.getElementById('edit-location').value;

            if (!name) {
                showEditMessage('Name is required', 'error');
                return;
            }

            const saveButton = document.getElementById('save-profile');
            const originalText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<div class="loading-spinner mx-auto"></div> Saving...';

            try {
                await user.updateProfile({
                    displayName: name
                });
                await db.collection('users').doc(user.uid).update({
                    name: name,
                    phone: phone,
                    location: location
                });

                document.getElementById('user-name').textContent = name;
                document.getElementById('account-name').textContent = name;
                document.getElementById('account-phone').textContent = phone || 'Not set';
                document.getElementById('account-location').textContent = location || 'Not set';

                showEditMessage('Profile updated successfully', 'success');
            } catch (error) {
                showEditMessage('Error updating profile: ' + error.message, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
            }
        }

        // Show edit message
        function showEditMessage(message, type) {
            const element = document.getElementById('edit-message');
            element.textContent = message;
            element.className = `mt-4 p-3 rounded-lg text-center ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            element.classList.remove('hidden');
        }

        async function handleSuccessfulPayment(response, amount, plots, property) {
            showToast(`Payment of ₦${parseInt(amount).toLocaleString()} completed for ${property.title}`, 'success');
            showPaymentSuccess(property, amount);

            await addInvestmentWithTransaction(
                auth.currentUser.uid,
                property.id,
                property.title,
                parseInt(amount),
                plots,
                property.location,
                response.reference
            );

            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center';
            notification.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                <span>Your dashboard has been updated with your new investment</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 5000);
        }

        // Process payment with Paystack
        async function processPayment() {
            const propertyId = document.getElementById('payment-property').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const email = document.getElementById('payment-email').value || auth.currentUser?.email;
            const plots = parseFloat(document.getElementById('payment-plots').value);

            if (!propertyId) { showPaymentMessage('Please select a property', 'error'); return; }
            if (!amount || isNaN(amount) || amount < 100) { showPaymentMessage('Amount must be at least ₦100', 'error'); return; } // Adjusted for testing, you can set your minimum
            if (!email) { showPaymentMessage('Please enter a valid email', 'error'); return; }
            if (!plots || isNaN(plots) || plots <= 0) { showPaymentMessage('Please enter a valid number of plots', 'error'); return; }

            try {
                const response = await fetch('/.netlify/functions/initialize-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, amount }),
                });

                if (!response.ok) {
                    throw new Error('Payment initialization failed.');
                }

                const data = await response.json();
                const { authorization_url } = data.data;

                // Redirect to Paystack's payment page
                window.location.href = authorization_url;

            } catch (error) {
                console.error('Payment Error:', error);
                showPaymentMessage('Could not initiate payment. Please try again.', 'error');
            }
        }

        // Proceed to payment from calculator
        function proceedToPaymentFromCalculator() {
            const propertySelect = document.getElementById('calculator-property');
            const propertyId = propertySelect.value;
            if (!propertyId) { showToast('Please select a property first', 'error'); return; }

            const pricePerPlot = parseFloat(document.getElementById('price-per-plot').value);
            const numberOfPlots = parseFloat(document.getElementById('number-of-plots').value);
            const totalPrice = pricePerPlot * numberOfPlots;

            if (totalPrice < 100000) { showToast('Minimum amount is ₦100,000', 'error'); return; }

            getProperty(propertyId).then(property => {
                if (!property) { showToast('Property not found', 'error'); return; }
                const handler = PaystackPop.setup({
                    key: paystack.publicKey,
                    email: auth.currentUser?.email || '',
                    amount: totalPrice * 100,
                    currency: 'NGN',
                    ref: 'LP_' + Math.floor(Math.random() * 1000000000),
                    callback: function (response) {
                        app.calculatorResult.classList.add('hidden');
                        handleSuccessfulPayment(response, totalPrice, numberOfPlots, property);
                    },
                    onClose: function () {
                        showToast('Payment window was closed', 'warning');
                    }
                });
                handler.openIframe();
            });
        }

        // Calculate total price
        function calculateTotalPrice() {
            const pricePerPlot = parseFloat(document.getElementById('price-per-plot').value);
            const numberOfPlots = parseFloat(document.getElementById('number-of-plots').value);

            if (isNaN(pricePerPlot) || isNaN(numberOfPlots) || pricePerPlot <= 0 || numberOfPlots <= 0) {
                showToast('Please enter valid numbers for both fields', 'error');
                return;
            }

            const totalPrice = pricePerPlot * numberOfPlots;

            if (totalPrice < 100000) { showToast('Minimum amount is ₦100,000', 'error'); return; }

            document.getElementById('calculator-result').classList.remove('hidden');
            document.getElementById('result-text').textContent = `Total Price: ₦${totalPrice.toLocaleString()}`;
            document.getElementById('proceed-to-payment').classList.remove('hidden');
        }

        // List property for sale
        async function listPropertyForSale() {
            const investmentId = document.getElementById('sell-property-select').value;
            const sellPrice = document.getElementById('sell-price').value;
            const bankName = document.getElementById('bank-name').value;
            const accountName = document.getElementById('account-name-input').value;
            const accountNumber = document.getElementById('account-number').value;

            if (!investmentId) { showSellMessage('Please select a property to sell', 'error'); return; }
            if (!sellPrice || isNaN(sellPrice) || sellPrice <= 0) { showSellMessage('Please enter a valid selling price', 'error'); return; }
            if (!bankName || !accountName || !accountNumber) { showSellMessage('Please provide your bank details', 'error'); return; }

            const submitButton = document.getElementById('submit-sale');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner mx-auto"></div> Processing...';

            try {
                await db.collection('investments').doc(investmentId).update({
                    status: 'for_sale',
                    sellingPrice: parseFloat(sellPrice),
                    bankDetails: {
                        bankName: bankName,
                        accountName: accountName,
                        accountNumber: accountNumber
                    },
                    listedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSellMessage(`Your property has been listed for sale at ₦${parseInt(sellPrice).toLocaleString()}`, 'success');

                setTimeout(() => {
                    app.sellPropertyModal.classList.add('hidden');
                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center';
                    notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i><span>Your property has been listed for sale</span>`;
                    document.body.appendChild(notification);
                    setTimeout(() => { document.body.removeChild(notification); }, 5000);
                    if (auth.currentUser) { renderInvestments(auth.currentUser.uid); }
                }, 2000);
            } catch (error) {
                showSellMessage('Error listing property: ' + error.message, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        }

        // Show sell message
        function showSellMessage(message, type) {
            const element = document.getElementById('sell-message');
            element.textContent = message;
            element.className = `mt-4 p-3 rounded-lg text-center ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            element.classList.remove('hidden');
        }

        // Update all investments (admin function)
        function updateAllInvestments() {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center';
            notification.innerHTML = `<div class="loading-spinner mr-3"></div><span>Updating all investments...</span>`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i><span>All investments have been updated</span>`;
                setTimeout(() => { document.body.removeChild(notification); }, 5000);
            }, 3000);
        }

        // Add new property (admin function)
        async function addNewProperty() {
            const title = document.getElementById('property-title').value;
            const price = document.getElementById('property-price').value;
            const sqm = document.getElementById('property-sqm').value;
            const location = document.getElementById('property-location').value;
            const description = document.getElementById('property-description').value;
            const image = document.getElementById('property-image').value;

            if (!title || !price || !sqm || !location || !description) { showPropertyMessage('Please fill in all required fields', 'error'); return; }

            const submitButton = document.getElementById('submit-property');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner mx-auto"></div> Adding...';

            try {
                await db.collection('properties').add({
                    title: title,
                    price: parseFloat(price),
                    sqm: parseFloat(sqm),
                    location: location,
                    description: description,
                    image: image || "https://i.postimg.cc/RC3ZS7gj/apex-1.jpg",
                    status: "available",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showPropertyMessage(`New property "${title}" has been added`, 'success');
                loadProperties(true);
                document.getElementById('add-property-modal').reset();
                setTimeout(() => { app.addPropertyModal.classList.add('hidden'); }, 1500);
            } catch (error) {
                showPropertyMessage('Error adding property: ' + error.message, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        }

        // Show property message
        function showPropertyMessage(message, type) {
            const element = document.getElementById('property-message');
            element.textContent = message;
            element.className = `mt-4 p-3 rounded-lg text-center ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            element.classList.remove('hidden');
        }

        // Show payment message
        function showPaymentMessage(message, type) {
            const element = document.getElementById('payment-message');
            element.textContent = message;
            element.className = `mt-4 p-3 rounded-lg text-center ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            element.classList.remove('hidden');
        }

        // Show payment success
        function showPaymentSuccess(property, amount) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 auth-form">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-green-600 text-2xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-green-800 mb-2">Payment Successful</h2>
                        <p class="text-gray-700 mb-4">You have successfully paid ₦${parseInt(amount).toLocaleString()} for ${property.title}</p>
                        <p class="text-sm text-gray-500 mb-6">A receipt has been sent to your email address. Your dashboard will be updated within 24 hours.</p>
                        <button class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 transition" id="close-payment-success">
                            Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#close-payment-success').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // Apply filters
        async function applyFilters() {
            const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
            const locationFilter = document.getElementById('filter-location').value;

            try {
                const properties = await getProperties({
                    minPrice: minPrice,
                    maxPrice: maxPrice,
                    location: locationFilter || undefined
                });
                pagination.currentPage = 1;
                renderProperties(properties);
            } catch (error) {
                console.error("Error filtering properties:", error);
                showToast("Error applying filters", "error");
            }
        }

        // Search properties
        async function searchProperties() {
            const query = document.getElementById('search-properties').value.toLowerCase();
            const allProperties = await getProperties({ status: null }); // Search all statuses in dashboard

            const filtered = allProperties.filter(property => {
                return property.title.toLowerCase().includes(query) ||
                    property.location.toLowerCase().includes(query) ||
                    property.description.toLowerCase().includes(query);
            });

            pagination.currentPage = 1;
            renderProperties(filtered, true);
        }

        // Helper function to show toast messages
        function showToast(message, type) {
            const existingToasts = document.querySelectorAll('.toast-message');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = `toast-message fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg flex items-center ${type === 'error' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i><span>${message}</span>`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => { toast.remove(); }, 300);
            }, 5000);
        }
    </script>

    <script>
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            const deferredPrompt = e;

            const installButton = document.createElement('button');
            installButton.textContent = 'Install App';
            installButton.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg z-50';
            installButton.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted install prompt');
                    } else {
                        console.log('User dismissed install prompt');
                    }
                    document.body.removeChild(installButton);
                });
            };
            document.body.appendChild(installButton);
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <div id="chatbot-container" class="fixed bottom-5 right-5 z-50">
        <button id="chatbot-toggle"
            class="bg-green-700 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-green-800 transition">
            <i id="chat-icon" class="fas fa-comment-dots text-2xl"></i>
            <i id="close-icon" class="fas fa-times text-2xl hidden"></i>
        </button>

        <div id="chatbot-window"
            class="hidden absolute bottom-20 right-0 w-80 sm:w-96 bg-white rounded-lg shadow-2xl flex flex-col transition-transform duration-300 transform origin-bottom-right">
            <div class="bg-green-700 text-white p-4 rounded-t-lg flex items-center">
                <i class="fas fa-robot mr-3 text-2xl"></i>
                <div>
                    <h3 class="font-bold text-lg">NaijaLand Assistant</h3>
                    <p class="text-sm opacity-90">I'm here to help you!</p>
                </div>
            </div>

            <div id="chatbot-messages" class="flex-1 p-4 overflow-y-auto h-80">
                <div class="flex mb-4">
                    <div class="bg-green-100 text-green-800 p-3 rounded-lg max-w-xs">
                        <p>Welcome to NaijaLand! How can I assist you with buying verified and affordable land in
                            Nigeria today?</p>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-200">
                <div class="flex">
                    <input type="text" id="chatbot-input" placeholder="Type your message..."
                        class="flex-1 p-3 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-600">
                    <button id="chatbot-send"
                        class="bg-green-700 text-white px-5 py-3 rounded-r-lg hover:bg-green-800 transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatbotToggle = document.getElementById('chatbot-toggle');
            const chatbotWindow = document.getElementById('chatbot-window');
            const chatIcon = document.getElementById('chat-icon');
            const closeIcon = document.getElementById('close-icon');
            const messagesContainer = document.getElementById('chatbot-messages');
            const input = document.getElementById('chatbot-input');
            const sendButton = document.getElementById('chatbot-send');

            // State to hold the conversation history
            let conversationHistory = [];

            // Toggle chatbot window
            chatbotToggle.addEventListener('click', () => {
                const isHidden = chatbotWindow.classList.contains('hidden');
                chatbotWindow.classList.toggle('hidden', !isHidden);
                chatIcon.classList.toggle('hidden', !isHidden);
                closeIcon.classList.toggle('hidden', isHidden);
                if (!isHidden) {
                    input.focus();
                }
            });

            // Function to add a message to the UI
            const addMessage = (sender, text) => {
                const messageDiv = document.createElement('div');
                const messageBubble = document.createElement('div');

                messageDiv.classList.add('flex', 'mb-4');
                messageBubble.innerHTML = `<p>${text}</p>`; // Use innerHTML to render formatted text

                if (sender === 'user') {
                    messageDiv.classList.add('justify-end');
                    messageBubble.classList.add('bg-blue-500', 'text-white', 'p-3', 'rounded-lg', 'max-w-xs');
                } else {
                    messageBubble.classList.add('bg-green-100', 'text-green-800', 'p-3', 'rounded-lg', 'max-w-xs');
                }

                messageDiv.appendChild(messageBubble);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight; // Auto-scroll
            };

            // Function to handle sending a message
            const handleSendMessage = async () => {
                const userMessage = input.value.trim();
                if (!userMessage) return;

                // Add user message to UI and history
                addMessage('user', userMessage);
                conversationHistory.push({ role: 'user', content: userMessage });
                input.value = '';
                sendButton.disabled = true;

                // Show typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('flex', 'mb-4', 'typing-indicator');
                typingIndicator.innerHTML = `
                                <div class="bg-green-100 text-green-800 p-3 rounded-lg max-w-xs">
                                    <p class="animate-pulse">NaijaLand Assistant is typing...</p>
                                </div>
                            `;
                messagesContainer.appendChild(typingIndicator);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                try {
                    // Send the entire conversation history to the backend
                    const response = await fetch('/.netlify/functions/deepseek-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: conversationHistory }),
                    });

                    // Remove typing indicator
                    messagesContainer.removeChild(typingIndicator);

                    if (!response.ok) {
                        throw new Error('The chatbot is currently unavailable. Please try again later.');
                    }

                    const data = await response.json();
                    const botResponse = data.choices[0].message.content;

                    // Add bot response to UI and history
                    addMessage('bot', botResponse);
                    conversationHistory.push({ role: 'assistant', content: botResponse });

                } catch (error) {
                    if (messagesContainer.contains(typingIndicator)) {
                        messagesContainer.removeChild(typingIndicator);
                    }
                    addMessage('bot', "I'm having trouble connecting right now. Please check your connection or try again in a moment.");
                } finally {
                    sendButton.disabled = false;
                    input.focus();
                }
            };

            // Event Listeners
            sendButton.addEventListener('click', handleSendMessage);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });
        });
    </script>
</body>

</html>